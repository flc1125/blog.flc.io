<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spacebridge - 你的云端剪贴板</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, deleteDoc, doc, updateDoc, serverTimestamp, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Fix: Alias 'ref' to 'firebaseRef' to avoid conflict with Vue's ref
        import { getStorage, ref as firebaseRef, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- 全局变量与配置 ---
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Vue App
        const { createApp, ref, reactive, onMounted, computed, watch } = Vue;

        createApp({
            setup() {
                // --- 状态管理 ---
                const user = ref(null);
                const isAuthLoading = ref(true);
                const view = ref('landing'); // 'landing' (访客), 'dashboard' (主人列表), 'editor' (主人编辑), 'viewer' (访客查看)

                // 数据状态
                const inputCode = ref('');
                const sessions = ref([]); // 主人的所有资料包
                const currentSession = ref(null); // 当前正在编辑/查看的资料包
                const sessionLoading = ref(false);
                const errorMsg = ref('');
                const successMsg = ref('');

                // 上传状态
                const isUploading = ref(false);
                const uploadProgress = ref(0);

                // --- 核心工具函数 ---

                // 显示消息 Toast
                const showToast = (msg, type = 'success') => {
                    if (type === 'error') {
                        errorMsg.value = msg;
                        setTimeout(() => errorMsg.value = '', 4000);
                    } else {
                        successMsg.value = msg;
                        setTimeout(() => successMsg.value = '', 3000);
                    }
                };

                // 获取集合引用 (遵循 RULE 1 - 公共路径以便分享)
                // 注意：为了让访客能读到，我们需要把数据放在 public 路径下。
                // 安全性通过应用层逻辑（访客必须知道 code）和 Owner 字段过滤来保证。
                const getSessionsRef = () => collection(db, 'artifacts', appId, 'public', 'data', 'spacebridge_v2_sessions');

                // --- 认证逻辑 ---
                onMounted(async () => {
                    // 1. 优先尝试 Token 登录 (Spacebridge 环境)
                    // 2. 失败或无 Token 则匿名登录 (访客模式)
                    if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, window.__initial_auth_token);
                        } catch (e) {
                            console.error("Token auth failed", e);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }

                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        isAuthLoading.value = false;
                        if (u && !u.isAnonymous) {
                            // 如果是正式用户，自动加载 Dashboard
                            view.value = 'dashboard';
                            loadOwnerSessions();
                        }
                    });
                });

                const loginWithGoogle = async () => {
                    try {
                        const provider = new GoogleAuthProvider();
                        await signInWithPopup(auth, provider);
                    } catch (e) {
                        showToast("登录失败: " + e.message, 'error');
                    }
                };

                const logout = async () => {
                    await signOut(auth);
                    view.value = 'landing';
                    sessions.value = [];
                    currentSession.value = null;
                    // 登出后自动匿名登录以保持连接
                    await signInAnonymously(auth);
                };

                // --- 业务逻辑：访客 (Guest) ---

                const enterCode = async () => {
                    if (!inputCode.value || inputCode.value.length !== 6) {
                        showToast("请输入 6 位取件码", 'error');
                        return;
                    }

                    sessionLoading.value = true;
                    try {
                        // 查询匹配 Code 且 active 的会话
                        // RULE 2: No complex queries. Fetch simple.
                        // 这里我们用 where 查 code。
                        const q = query(getSessionsRef(), where("accessCode", "==", inputCode.value));
                        const snapshot = await getDocs(q);

                        if (snapshot.empty) {
                            showToast("未找到资料包或已失效", 'error');
                            sessionLoading.value = false;
                            return;
                        }

                        const docData = snapshot.docs[0].data();
                        const docId = snapshot.docs[0].id;

                        if (!docData.isActive) {
                            showToast("该资料包已被主人关闭分享", 'error');
                            sessionLoading.value = false;
                            return;
                        }

                        currentSession.value = { id: docId, ...docData };
                        view.value = 'viewer';

                        // 开启实时监听 (访客端也能看到主人实时打字)
                        subscribeToSession(docId);

                    } catch (e) {
                        console.error(e);
                        showToast("查找失败，请重试", 'error');
                    } finally {
                        sessionLoading.value = false;
                    }
                };

                // --- 业务逻辑：主人 (Owner) ---

                // 加载主人的所有会话
                const loadOwnerSessions = () => {
                    if (!user.value || user.value.isAnonymous) return;

                    // RULE 2: Firestore limitations. 我们拉取所有，前端过滤 ownerId
                    // 实际生产中应结合 Security Rules 和 userId 索引，这里为了符合 "public" 路径规则做折中。
                    // 优化：其实我们可以在 public 下存，但 owner 字段设为 uid。
                    // 为了性能，我们这里只监听 "createdBy == uid" 的查询
                    const q = query(getSessionsRef(), where("createdBy", "==", user.value.uid));

                    onSnapshot(q, (snapshot) => {
                        sessions.value = snapshot.docs.map(d => ({ id: d.id, ...d.data() }))
                                .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)); // 前端排序
                    }, (err) => {
                        console.error("Load sessions error", err);
                    });
                };

                // 创建新会话
                const createSession = async () => {
                    const code = Math.floor(100000 + Math.random() * 900000).toString();
                    const newSession = {
                        title: "新建资料包 " + new Date().toLocaleDateString(),
                        accessCode: code,
                        textContent: "",
                        files: [], // Array of { name, url, path, size, type }
                        isActive: true,
                        createdBy: user.value.uid,
                        ownerEmail: user.value.email,
                        createdAt: serverTimestamp()
                    };

                    try {
                        const docRef = await addDoc(getSessionsRef(), newSession);
                        // 创建后直接进入编辑模式
                        currentSession.value = { id: docRef.id, ...newSession };
                        view.value = 'editor';
                        subscribeToSession(docRef.id);
                        showToast(`资料包已创建，取件码：${code}`);
                    } catch (e) {
                        showToast("创建失败", 'error');
                    }
                };

                const deleteSession = async (sessionId, e) => {
                    e.stopPropagation(); // 防止触发点击进入
                    if (!confirm("确定要删除这个资料包吗？文件也将被清理。")) return;
                    try {
                        await deleteDoc(doc(getSessionsRef(), sessionId));
                        // TODO: 应该同时也删除 Storage 里的文件，这里简化处理
                        if (currentSession.value && currentSession.value.id === sessionId) {
                            view.value = 'dashboard';
                            currentSession.value = null;
                        }
                        showToast("已删除");
                    } catch (err) {
                        showToast("删除失败", 'error');
                    }
                };

                const toggleSessionStatus = async (session) => {
                    try {
                        const newStatus = !session.isActive;
                        await updateDoc(doc(getSessionsRef(), session.id), { isActive: newStatus });
                        showToast(newStatus ? "取件码已激活" : "取件码已冻结");
                    } catch (e) {
                        showToast("操作失败", 'error');
                    }
                };

                // 进入编辑模式
                const openSession = (session) => {
                    currentSession.value = session;
                    view.value = 'editor';
                    subscribeToSession(session.id);
                };

                // --- 通用逻辑：实时同步与文件 ---

                let unsubscribeSession = null;
                const subscribeToSession = (sessionId) => {
                    if (unsubscribeSession) unsubscribeSession();

                    unsubscribeSession = onSnapshot(doc(getSessionsRef(), sessionId), (docSnap) => {
                        if (docSnap.exists()) {
                            // 保持本地状态同步，特别是 textContent 和 files
                            const data = docSnap.data();
                            // 如果正在编辑文本，不要通过快照覆盖，除非是别人改的（简单起见，这里直接覆盖，打字会有光标跳动风险，需防抖）
                            // 简单防抖：如果内容一样就不动
                            if (currentSession.value && currentSession.value.textContent !== data.textContent) {
                                currentSession.value.textContent = data.textContent;
                            }
                            // 同步文件列表
                            currentSession.value.files = data.files || [];
                            currentSession.value.isActive = data.isActive;
                            currentSession.value.title = data.title;
                        } else {
                            // 文档被删了
                            if (view.value === 'viewer' || view.value === 'editor') {
                                showToast("该资料包已被删除", 'error');
                                backToHome();
                            }
                        }
                    });
                };

                // 自动保存文本 (防抖)
                let saveTimeout = null;
                const handleTextChange = (e) => {
                    const newText = e.target.value;
                    currentSession.value.textContent = newText; // 本地立即更新

                    if (view.value !== 'editor') return; // 只有 Owner 能写

                    if (saveTimeout) clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(async () => {
                        try {
                            await updateDoc(doc(getSessionsRef(), currentSession.value.id), {
                                textContent: newText
                            });
                        } catch (err) {
                            console.error("Auto-save failed", err);
                        }
                    }, 500); // 500ms 防抖
                };

                const handleFileUpload = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    if (file.size > 50 * 1024 * 1024) {
                        showToast("文件不能超过 50MB", 'error');
                        return;
                    }

                    isUploading.value = true;
                    try {
                        // FIX: Strict Path Rule for Storage (artifacts/{appId}/public/data/...)
                        const storagePath = `artifacts/${appId}/public/data/spacebridge_uploads/${currentSession.value.id}/${Date.now()}_${file.name}`;
                        const storageRef = firebaseRef(storage, storagePath);

                        const snapshot = await uploadBytes(storageRef, file);
                        const url = await getDownloadURL(snapshot.ref);

                        const newFile = {
                            name: file.name,
                            url: url,
                            path: snapshot.ref.fullPath,
                            size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                            type: file.type,
                            uploadedAt: Date.now()
                        };

                        // 更新 Firestore
                        const updatedFiles = [...(currentSession.value.files || []), newFile];
                        await updateDoc(doc(getSessionsRef(), currentSession.value.id), {
                            files: updatedFiles
                        });
                        showToast("上传成功");
                    } catch (err) {
                        console.error(err);
                        showToast("上传失败: " + err.code, 'error');
                    } finally {
                        isUploading.value = false;
                        // 清空 input
                        e.target.value = '';
                    }
                };

                const removeFile = async (fileIndex, fileData) => {
                    if (!confirm("确定删除此文件？")) return;
                    try {
                        // 1. 更新 Firestore (先移出列表，这就看不到了)
                        const updatedFiles = [...currentSession.value.files];
                        updatedFiles.splice(fileIndex, 1);
                        await updateDoc(doc(getSessionsRef(), currentSession.value.id), {
                            files: updatedFiles
                        });

                        // 2. 删除 Storage 实体 (可选，为了省空间)
                        // const fileRef = firebaseRef(storage, fileData.path);
                        // await deleteObject(fileRef);

                        showToast("文件已移除");
                    } catch (err) {
                        showToast("移除失败", 'error');
                    }
                };

                const updateTitle = async (e) => {
                    await updateDoc(doc(getSessionsRef(), currentSession.value.id), {
                        title: e.target.value
                    });
                };

                const copyText = () => {
                    if (!currentSession.value?.textContent) return;
                    // 使用 textContent 复制
                    const textArea = document.createElement("textarea");
                    textArea.value = currentSession.value.textContent;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy'); // Fallback
                    document.body.removeChild(textArea);
                    showToast("文本已复制到剪贴板");
                };

                const backToHome = () => {
                    if (unsubscribeSession) unsubscribeSession();
                    currentSession.value = null;
                    inputCode.value = '';
                    if (user.value && !user.value.isAnonymous) {
                        view.value = 'dashboard';
                    } else {
                        view.value = 'landing';
                    }
                };

                // 计算属性
                const isOwner = computed(() => {
                    return user.value && !user.value.isAnonymous;
                });

                return {
                    user, isAuthLoading, view, inputCode, sessions, currentSession, sessionLoading,
                    errorMsg, successMsg, isUploading, isOwner,
                    loginWithGoogle, logout, enterCode, createSession, deleteSession,
                    toggleSessionStatus, openSession, handleTextChange, handleFileUpload,
                    removeFile, updateTitle, copyText, backToHome
                };
            }
        }).mount('#app');
    </script>

    <!-- Icons Component (Simple SVG wrapper) -->
    <script>
        // 为了简化，直接在模板里用 SVG，或者这里定义一个简单的组件
        // 这里我们在模板里直接写 SVG 代码，或者使用 Lucide 的 CDN 版本有点麻烦。
        // 既然用了 Vue，我们直接定义 functional component 比较干净，或者直接 inline。
        // 下面的 HTML 模板中将大量使用 Inline SVG 以保证单文件稳定性。
    </script>

    <style>
        /* Custom Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.3s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }
        /* Hide scrollbar for text area */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen font-sans selection:bg-indigo-100 selection:text-indigo-700">
<div id="app" class="min-h-screen flex flex-col relative overflow-hidden">

    <!-- 背景装饰 -->
    <div class="absolute top-0 left-0 w-full h-96 bg-gradient-to-b from-indigo-50 to-transparent -z-10"></div>
    <div class="absolute -top-20 -right-20 w-96 h-96 bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob"></div>
    <div class="absolute -top-20 -left-20 w-96 h-96 bg-purple-100 rounded-full mix-blend-multiply filter blur-3xl opacity-50 animate-blob animation-delay-2000"></div>

    <!-- Toast Notifications -->
    <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2 pointer-events-none">
        <transition name="fade">
            <div v-if="errorMsg" class="bg-red-50 text-red-600 px-6 py-3 rounded-full shadow-lg border border-red-100 flex items-center gap-2 font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                {{ errorMsg }}
            </div>
        </transition>
        <transition name="fade">
            <div v-if="successMsg" class="bg-emerald-50 text-emerald-600 px-6 py-3 rounded-full shadow-lg border border-emerald-100 flex items-center gap-2 font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                {{ successMsg }}
            </div>
        </transition>
    </div>

    <!-- Navbar -->
    <nav class="w-full px-6 py-4 flex justify-between items-center z-10">
        <div class="flex items-center gap-2 cursor-pointer" @click="backToHome">
            <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white shadow-md shadow-indigo-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </div>
            <span class="text-xl font-bold tracking-tight text-slate-800">Spacebridge</span>
        </div>

        <div v-if="!isAuthLoading">
            <div v-if="user && !user.isAnonymous" class="flex items-center gap-4">
                <span class="hidden sm:block text-sm text-slate-500">{{ user.displayName || user.email }}</span>
                <button @click="logout" class="p-2 text-slate-400 hover:text-slate-600 transition-colors" title="退出登录">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
            <div v-else>
                <button @click="loginWithGoogle" class="flex items-center gap-2 px-4 py-2 bg-white text-slate-700 rounded-full text-sm font-medium shadow-sm border border-slate-200 hover:bg-slate-50 hover:border-slate-300 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                    主人登录
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col items-center justify-center p-4 sm:p-6 w-full max-w-6xl mx-auto z-10">

        <!-- VIEW: Landing (Guest Input) -->
        <transition name="fade" mode="out-in">
            <div v-if="view === 'landing'" class="w-full max-w-md text-center flex flex-col items-center">
                <h1 class="text-4xl font-extrabold text-slate-900 mb-2">隔空取物</h1>
                <p class="text-slate-500 mb-8">输入 6 位取件码，提取会议资料</p>

                <div class="relative w-full group">
                    <input
                            v-model="inputCode"
                            type="text"
                            maxlength="6"
                            placeholder="______"
                            class="w-full text-center text-4xl tracking-[0.5em] font-mono py-6 rounded-2xl border-2 border-slate-200 bg-white shadow-xl shadow-slate-200/50 focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all placeholder:text-slate-200"
                            @keyup.enter="enterCode"
                    >
                    <button
                            @click="enterCode"
                            :disabled="sessionLoading || inputCode.length !== 6"
                            class="absolute right-3 top-1/2 -translate-y-1/2 p-3 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-lg shadow-indigo-200"
                    >
                        <svg v-if="sessionLoading" class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        <svg v-else xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                    </button>
                </div>
            </div>

            <!-- VIEW: Dashboard (Owner List) -->
            <div v-else-if="view === 'dashboard'" class="w-full h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">我的资料包</h2>
                    <button @click="createSession" class="flex items-center gap-2 px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl shadow-lg shadow-indigo-200 transition-all font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        新建
                    </button>
                </div>

                <div v-if="sessions.length === 0" class="flex-1 flex flex-col items-center justify-center text-slate-400 border-2 border-dashed border-slate-200 rounded-3xl p-10 bg-slate-50/50">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="mb-4 opacity-50"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                    <p>还没有资料包，点击右上角新建</p>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 auto-rows-max">
                    <div
                            v-for="session in sessions"
                            :key="session.id"
                            @click="openSession(session)"
                            class="group relative bg-white rounded-2xl p-6 border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer overflow-hidden"
                            :class="{'opacity-75 bg-slate-50': !session.isActive}"
                    >
                        <!-- Badge -->
                        <div class="absolute top-4 right-4">
                                <span v-if="session.isActive" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    激活
                                </span>
                            <span v-else class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-600">
                                    已关闭
                                </span>
                        </div>

                        <h3 class="font-bold text-lg text-slate-800 mb-1 pr-16 truncate">{{ session.title }}</h3>
                        <div class="text-3xl font-mono tracking-widest text-indigo-600 font-bold mb-4">{{ session.accessCode }}</div>

                        <div class="flex items-center justify-between text-sm text-slate-500 mt-4 pt-4 border-t border-slate-100">
                            <div class="flex items-center gap-3">
                                    <span class="flex items-center gap-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                        {{ session.files ? session.files.length : 0 }}
                                    </span>
                                <span class="flex items-center gap-1" v-if="session.textContent">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
                                        文字
                                    </span>
                            </div>
                            <button @click="deleteSession(session.id, $event)" class="text-slate-300 hover:text-red-500 transition-colors p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: Editor/Viewer (Session Detail) -->
            <div v-else-if="(view === 'editor' || view === 'viewer') && currentSession" class="w-full h-full flex flex-col gap-6">

                <!-- Top Bar -->
                <div class="glass-panel rounded-2xl p-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-sm">
                    <div class="flex-1 w-full">
                        <input
                                v-if="view === 'editor'"
                                :value="currentSession.title"
                                @input="updateTitle"
                                class="w-full bg-transparent text-lg font-bold text-slate-800 focus:outline-none placeholder:text-slate-400"
                                placeholder="输入标题..."
                        >
                        <h2 v-else class="text-lg font-bold text-slate-800">{{ currentSession.title }}</h2>
                    </div>

                    <div class="flex items-center gap-4 bg-slate-50 px-4 py-2 rounded-xl border border-slate-100">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">CODE</span>
                        <span class="text-2xl font-mono font-bold text-indigo-600">{{ currentSession.accessCode }}</span>
                    </div>

                    <div v-if="view === 'editor'" class="flex items-center gap-2">
                        <button @click="toggleSessionStatus(currentSession)" class="p-2 rounded-lg transition-colors" :class="currentSession.isActive ? 'text-green-600 bg-green-50 hover:bg-green-100' : 'text-slate-400 bg-slate-100 hover:bg-slate-200'" :title="currentSession.isActive ? '点击冻结' : '点击激活'">
                            <svg v-if="currentSession.isActive" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                            <svg v-else xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-6 min-h-0">

                    <!-- Left: Text Area -->
                    <div class="flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden h-[500px] md:h-auto">
                        <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                                <span class="text-sm font-medium text-slate-500 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                    文本剪贴板
                                </span>
                            <button @click="copyText" class="text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded text-xs font-medium transition-colors">一键复制</button>
                        </div>
                        <textarea
                                :value="currentSession.textContent"
                                @input="handleTextChange"
                                :readonly="view === 'viewer'"
                                class="flex-1 w-full p-4 resize-none focus:outline-none text-slate-700 leading-relaxed"
                                placeholder="在此处粘贴文本或链接..."
                        ></textarea>
                        <div v-if="view === 'editor'" class="px-4 py-2 bg-slate-50 text-xs text-slate-400 text-right">
                            自动保存中...
                        </div>
                    </div>

                    <!-- Right: Files -->
                    <div class="flex flex-col gap-4 h-[500px] md:h-auto overflow-hidden">
                        <!-- Dropzone (Owner Only) -->
                        <div v-if="view === 'editor'" class="relative shrink-0 group">
                            <input
                                    type="file"
                                    @change="handleFileUpload"
                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                                    :disabled="isUploading"
                            >
                            <div class="bg-white border-2 border-dashed border-slate-300 rounded-2xl p-6 flex flex-col items-center justify-center text-center transition-all group-hover:border-indigo-400 group-hover:bg-indigo-50/30">
                                <div v-if="isUploading" class="animate-pulse flex flex-col items-center">
                                    <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-3"></div>
                                    <p class="text-sm text-indigo-600 font-medium">上传中...</p>
                                </div>
                                <div v-else class="flex flex-col items-center">
                                    <div class="w-10 h-10 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    </div>
                                    <p class="text-sm font-medium text-slate-700">点击或拖拽上传文件</p>
                                    <p class="text-xs text-slate-400 mt-1">最大 50MB</p>
                                </div>
                            </div>
                        </div>

                        <!-- File List -->
                        <div class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden flex flex-col">
                            <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 text-sm font-medium text-slate-500 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                                文件列表 ({{ currentSession.files ? currentSession.files.length : 0 }})
                            </div>

                            <div class="flex-1 overflow-y-auto p-2 space-y-2">
                                <div v-if="!currentSession.files || currentSession.files.length === 0" class="h-full flex flex-col items-center justify-center text-slate-400">
                                    <p class="text-sm">暂无文件</p>
                                </div>

                                <div v-for="(file, idx) in currentSession.files" :key="idx" class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 border border-slate-100 hover:border-indigo-100 hover:shadow-sm transition-all group">
                                    <div class="w-10 h-10 rounded-lg bg-indigo-100 text-indigo-600 flex items-center justify-center shrink-0 font-bold text-xs">
                                        {{ file.name.split('.').pop().toUpperCase().slice(0,3) }}
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-slate-800 truncate" :title="file.name">{{ file.name }}</div>
                                        <div class="text-xs text-slate-500">{{ file.size }}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <a :href="file.url" target="_blank" download class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-lg transition-colors" title="下载">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                        </a>
                                        <button v-if="view === 'editor'" @click="removeFile(idx, file)" class="p-2 text-slate-400 hover:text-red-500 hover:bg-white rounded-lg transition-colors" title="删除">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </transition>
    </main>

    <footer class="py-4 text-center text-slate-300 text-xs">
        Spacebridge v2.0 • {{ user && !user.isAnonymous ? 'Owner Mode' : 'Guest Mode' }}
    </footer>
</div>
</body>
</html>