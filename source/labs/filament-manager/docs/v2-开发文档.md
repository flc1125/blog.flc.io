# 不焦虑耗材 (Filament Manager) v2 开发文档

**维护人:** FLC
**版本:** v2.0
**最后更新:** 2025-12-18
**文档类型:** 技术架构与开发指南

---

## 1. 项目概况

**“不焦虑耗材” (No-Anxiety Filament)** 是一个极简的、基于浏览器的 3D 打印耗材库存管理工具。

### 1.1 核心理念
*   **No-Build (无构建):** 采用原生 ES Modules，单文件 `index.html` 即可运行，无需 Node.js 环境、Webpack 或 Vite 打包。
*   **Serverless (无服务):** 后端完全依赖 Google Firebase (Auth + Firestore)，前端直连数据库。
*   **Visual First (视觉优先):** 以色卡墙形式直观展示库存，拒绝枯燥的表格。

### 1.2 技术栈
*   **Core:** [Vue 3](https://vuejs.org/) (ESM Browser Build)
*   **UI Framework:** [Tailwind CSS v3.x](https://tailwindcss.com/) (CDN)
*   **Icons:** [Phosphor Icons](https://phosphoricons.com/) (Web Script)
*   **Backend:** Google Firebase v10.7.1
    *   Authentication (Google Sign-In)
    *   Cloud Firestore (NoSQL Database)
*   **Font:** Google Fonts (Inter)

---

## 2. 架构设计

### 2.1 目录结构
项目保持极致扁平，核心逻辑全部封装在单一 HTML 文件中。

```text
/
├── index.html          # 核心应用文件 (HTML + CSS + JS)
├── logo.svg            # 应用图标
├── GEMINI.md           # AI 维护的项目上下文
└── docs/
    ├── v1-需求文档.md   # 历史需求
    └── v2-开发文档.md   # 本文档
```

### 2.2 数据模型 (Firestore Schema)

所有数据存储在 Firestore 的 `filaments` 集合中。

| 字段名 | 类型 | 说明 | 必填 |
| :--- | :--- | :--- | :--- |
| `id` | String | 文档唯一 ID (自动生成) | 是 |
| `uid` | String | 用户 UID (用于数据隔离) | 是 |
| `brand` | String | 品牌 (如 "Bambu Lab") | 是 |
| `type` | String | 材质 (如 "PLA Basic") | 是 |
| `colorName` | String | 颜色名称 (如 "Bambu Green") | 是 |
| `colorHex` | String | 16进制色值 (如 "#00AE42")，用于渲染 UI | 是 |
| `remaining` | Number | 剩余百分比 (0-100) | 是 |
| `purchaseDate` | String | 购买日期 (格式: "YYYY-MM-DD") | 否 |
| `note` | String | 备注 (如 "AMS 插槽 1") | 否 |
| `updatedAt` | Timestamp | 服务器时间戳 (用于排序) | 是 |

### 2.3 安全规则 (Firestore Security Rules)
必须配置以下规则以保证数据安全（用户只能访问自己的数据）：

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /filaments/{document} {
      // 创建时：必须已登录，且写入的 uid 必须等于当前用户 uid
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
      // 读取/更新/删除：必须已登录，且操作的文档 uid 等于当前用户 uid
      allow read, update, delete: if request.auth != null && resource.data.uid == request.auth.uid;
    }
  }
}
```

---

## 3. 功能实现细节

### 3.1 核心逻辑 (`index.html` Script 部分)

应用逻辑完全包含在 `<script type="module">` 块中，使用 Vue 3 Composition API (`setup`).

#### A. 状态管理
*   `filaments`: 实时同步的原始耗材列表。
*   `displayList`: **(核心 computed)** 经过“筛选 -> 排序 -> 聚合”处理后的最终渲染列表。
*   `currentTab`: 视图状态 (`stock` 库存中 / `depleted` 已耗尽)。
*   `isGrouped`: 是否开启聚合模式。

#### B. 智能聚合 (Smart Grouping)
在 `displayList` 计算属性中实现。
*   **聚合键 (Key):** `${brand}|${type}|${colorHex}|${colorName}`
*   **逻辑:** 当开启聚合且不在搜索模式下，系统会将具有相同 Key 的耗材合并为一个 `Group` 对象。
*   **Group 对象结构:** 包含 `totalRemaining` (总库存量) 和 `items` (原始耗材数组)。

#### C. 批量管理 (Batch Operations)
*   **状态:** `isSelectionMode` (Boolean), `selectedIds` (Set).
*   **交互:** 点击卡片左上角复选框，或在选择模式下点击卡片主体。
*   **操作:** 目前支持“批量删除”。

#### D. 预设系统 (Presets)
内置 `PRESETS` 常量，包含 Bambu Lab 官方色卡数据 (PLA Basic, Matte, Silk, CF, PETG, ABS, ASA, TPU 等)。
*   **功能:** 在“入库”弹窗中，点击色点可一键填充 `brand`, `type`, `colorName`, `colorHex`。

### 3.2 UI/UX 设计系统

*   **配色:** 主色调 Green-500/600，背景 Slate-50，文字 Slate-800。
*   **卡片设计:**
    *   顶部: 颜色预览区 (动态背景色)，自动计算文字反色 (黑/白)。
    *   底部: 信息区，包含品牌、进度条、剩余百分比。
    *   水位线: 即使在单卷卡片模式下，背景也通过透明度遮罩模拟了“水位”效果。
*   **动效:** 使用 Tailwind 的 `transition` 和 `animate-pulse` (低库存警告)。

---

## 4. 部署与环境

### 4.1 本地开发
由于使用了 ES Modules，不能直接双击打开 `index.html` (会有 CORS 错误)。
必须通过 HTTP 服务器运行：
```bash
# Python
python3 -m http.server 8000

# Node.js
npx http-server
```
访问: `http://localhost:8000`

### 4.2 线上部署
*   可以直接托管在任何静态网站托管服务上 (GitHub Pages, Vercel, Netlify, Cloudflare Pages)。
*   无需 Build 过程，上传即部署。

---

## 5. v2.x 规划 (Roadmap)

以下是后续迭代计划：

### 5.1 数据可视化 (Dashboard)
*   **目标:** 提供库存全貌的统计视图。
*   **指标:**
    *   总重量估算 (基于 1kg/卷假设)。
    *   材质分布饼图 (PLA vs PETG vs ABS)。
    *   品牌偏好排行。
*   **入口:** 顶部导航栏新增图标。

### 5.2 移动端优化 (PWA)
*   添加 `manifest.json` 和 Service Worker。
*   支持“添加到主屏幕”，全屏运行。
*   优化触摸交互（如左滑删除）。

### 5.3 数据导入/导出
*   支持导出库存数据为 JSON/CSV。
*   支持从 JSON 恢复数据 (方便数据迁移)。

### 5.4 更多预设
*   补充 PolyMaker, eSun, Sunlu 等第三方品牌常用色卡。
