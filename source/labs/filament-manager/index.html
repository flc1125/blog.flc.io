<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹“ç«¹è€—æåº“å­˜ç®¡ç† (v6 èšåˆä¸å½’æ¡£ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .filament-swatch { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .filament-swatch:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }

        /* èšåˆå¡ç‰‡çš„å †å æ•ˆæœ */
        .group-stack::before {
            content: ''; position: absolute; top: -4px; left: 6px; right: 6px; height: 10px;
            background: inherit; opacity: 0.6; border-radius: 12px 12px 0 0; z-index: -1;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.05);
        }
        .group-stack::after {
            content: ''; position: absolute; top: -8px; left: 12px; right: 12px; height: 10px;
            background: inherit; opacity: 0.3; border-radius: 12px 12px 0 0; z-index: -2;
        }

        /* é¢„è®¾é¢œè‰²åœ†ç‚¹åŠ¨ç”» */
        .color-dot { transition: transform 0.2s, ring-width 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot:active { transform: scale(0.95); }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<div id="app" v-cloak class="min-h-screen flex flex-col">

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="bg-green-500 text-white p-1.5 rounded-lg">
                        <i class="ph-bold ph-spool text-xl"></i>
                    </div>
                    <span class="font-bold text-lg tracking-tight text-slate-800">Filament<span class="text-green-600">Manager</span></span>
                </div>

                <div class="flex items-center gap-4">
                    <div v-if="user" class="flex items-center gap-3">
                        <div class="hidden md:flex flex-col items-end mr-2">
                            <span class="text-sm font-medium text-slate-700">{{ user.displayName }}</span>
                            <!-- è¿™é‡Œçš„ç»Ÿè®¡æ”¹ä¸ºåŸºäºå½“å‰Tab -->
                            <span class="text-xs text-slate-500">{{ currentTab === 'stock' ? 'åº“å­˜' : 'å†å²' }}: {{ displayList.length }} é¡¹</span>
                        </div>
                        <img :src="user.photoURL" class="h-9 w-9 rounded-full border border-slate-200" alt="Avatar">
                        <button @click="logout" class="p-2 text-slate-400 hover:text-red-500 transition-colors" title="é€€å‡ºç™»å½•">
                            <i class="ph-bold ph-sign-out text-xl"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- é”™è¯¯æç¤º -->
        <div v-if="configError" class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0"><i class="ph-fill ph-warning-circle text-red-500 text-xl"></i></div>
                <div class="ml-3"><p class="text-sm text-red-700">è¯·é…ç½® Firebase ä¿¡æ¯ã€‚</p></div>
            </div>
        </div>

        <div v-if="loadErrorMessage" class="bg-amber-50 border-l-4 border-amber-500 p-4 mb-6 rounded-r-lg animate-fade-in">
            <div class="flex">
                <div class="flex-shrink-0"><i class="ph-fill ph-info text-amber-500 text-xl"></i></div>
                <div class="ml-3">
                    <h3 class="text-sm font-bold text-amber-800">{{ loadErrorTitle || 'æç¤º' }}</h3>
                    <div class="mt-1 text-sm text-amber-700">
                        <p>{{ loadErrorMessage }}</p>
                        <div v-if="loadErrorMessage.includes('æ„å»º')" class="mt-2 flex items-center gap-2">
                            <div class="animate-spin h-4 w-4 border-2 border-amber-600 border-t-transparent rounded-full"></div>
                            <span class="text-xs text-amber-600">åå°å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div v-if="!user && !authLoading" class="flex flex-col items-center justify-center min-h-[60vh] text-center animate-fade-in">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600">
                <i class="ph-duotone ph-cube text-5xl"></i>
            </div>
            <h1 class="text-3xl font-bold text-slate-900 mb-3">ç®¡ç†ä½ çš„ 3D æ‰“å°è€—æ</h1>
            <p class="text-slate-500 max-w-md mb-8">æ”¯æŒæ‹“ç«¹ä¸ç¬¬ä¸‰æ–¹è€—æã€‚ç›´è§‚çš„è‰²å¡å¢™è§†å›¾ï¼Œç²¾ç¡®è®°å½•æ¯ä¸€å…‹å‰©ä½™åº“å­˜ã€‚</p>
            <button @click="login" class="flex items-center gap-3 bg-white border border-slate-300 hover:border-slate-400 hover:bg-slate-50 text-slate-700 px-8 py-3 rounded-xl font-medium shadow-sm transition-all transform active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                ä½¿ç”¨ Google è´¦å·ç™»å½•
            </button>
        </div>

        <!-- åŠ è½½ä¸­ -->
        <div v-if="authLoading" class="flex justify-center items-center min-h-[60vh]">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
        </div>

        <!-- åº“å­˜ç®¡ç†ç•Œé¢ -->
        <div v-if="user">

            <!-- é¡¶éƒ¨å·¥å…·æ  (Tab + Search + Toggle) -->
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4">

                <!-- å·¦ä¾§ï¼šTab åˆ‡æ¢ + æœç´¢ -->
                <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                    <!-- Tab -->
                    <div class="bg-slate-100 p-1 rounded-lg flex shrink-0">
                        <button @click="currentTab = 'stock'"
                                class="px-4 py-2 rounded-md text-sm font-medium transition-all"
                                :class="currentTab === 'stock' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'">
                            åº“å­˜ä¸­
                        </button>
                        <button @click="currentTab = 'depleted'"
                                class="px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center gap-1"
                                :class="currentTab === 'depleted' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'">
                            å·²è€—å°½ <span class="text-xs bg-slate-200 px-1.5 rounded-full">{{ depletedCount }}</span>
                        </button>
                    </div>

                    <!-- æœç´¢ -->
                    <div class="relative w-full sm:w-64 group">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-green-500"></i>
                        <input v-model="searchQuery" type="text" placeholder="æœç´¢é¢œè‰²ã€æè´¨..."
                               class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none transition-all shadow-sm">
                    </div>
                </div>

                <!-- å³ä¾§ï¼šèšåˆå¼€å…³ + æ·»åŠ æŒ‰é’® -->
                <div class="flex items-center gap-4 w-full lg:w-auto justify-between lg:justify-end">
                    <!-- èšåˆå¼€å…³ (ä»…åœ¨åº“å­˜Tabæ˜¾ç¤º) -->
                    <div v-if="currentTab === 'stock'" class="flex items-center gap-2 cursor-pointer select-none" @click="isGrouped = !isGrouped">
                        <div class="w-10 h-6 rounded-full transition-colors relative" :class="isGrouped ? 'bg-green-500' : 'bg-slate-200'">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-1 transition-transform"
                                 :style="{ left: isGrouped ? '22px' : '2px' }"></div>
                        </div>
                        <span class="text-sm font-medium text-slate-600">èšåˆç›¸åŒ</span>
                    </div>

                    <button @click="openModal()" class="flex items-center gap-2 bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg font-medium shadow-lg shadow-slate-900/20 transition-all active:scale-95">
                        <i class="ph-bold ph-plus"></i>
                        <span class="hidden sm:inline">å…¥åº“</span>
                    </button>
                </div>
            </div>

            <!-- åˆ—è¡¨åŒºåŸŸ -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5">

                <!-- æ–°å¢å¡ç‰‡ (ä»…åº“å­˜Tabæ˜¾ç¤º) -->
                <div v-if="currentTab === 'stock' && !searchQuery" @click="openModal()" class="cursor-pointer border-2 border-dashed border-slate-200 rounded-2xl flex flex-col items-center justify-center text-slate-400 hover:text-green-600 hover:border-green-300 hover:bg-green-50/50 transition-all min-h-[220px] group">
                    <div class="w-12 h-12 rounded-full bg-slate-100 group-hover:bg-green-100 flex items-center justify-center mb-2 transition-colors">
                        <i class="ph-bold ph-plus text-xl"></i>
                    </div>
                    <span class="text-sm font-medium">å…¥åº“æ–°è€—æ</span>
                </div>

                <!-- å¾ªç¯æ¸²æŸ“åˆ—è¡¨ -->
                <div v-for="item in displayList" :key="item.id || item.groupId"
                     @click="handleCardClick(item)"
                     class="filament-swatch relative group rounded-2xl overflow-visible cursor-pointer shadow-sm bg-white aspect-[4/5] flex flex-col z-0"
                     :class="{'group-stack': item.isGroup}">

                    <!-- é¢œè‰²å±•ç¤ºåŒº -->
                    <div class="relative flex-grow w-full overflow-hidden rounded-t-2xl" :style="{ backgroundColor: item.colorHex }">

                        <!-- èšåˆæ ‡è®° Badge -->
                        <div v-if="item.isGroup" class="absolute top-3 right-3 bg-white/90 backdrop-blur text-slate-800 px-2 py-0.5 rounded-md text-xs font-bold shadow-sm z-20 flex items-center gap-1">
                            <i class="ph-bold ph-stack"></i>
                            x{{ item.count }}
                        </div>

                        <!-- è€—å°½æ ‡è®° -->
                        <div v-if="currentTab === 'depleted'" class="absolute inset-0 bg-slate-900/40 z-20 flex items-center justify-center backdrop-grayscale">
                            <span class="border-2 border-white/50 text-white px-3 py-1 font-black text-xl tracking-widest -rotate-12 rounded opacity-80">EMPTY</span>
                        </div>

                        <!-- å‰©ä½™é‡é®ç½© (èšåˆå¡ç‰‡æ˜¾ç¤ºå¹³å‡å€¼ï¼Œæ™®é€šæ˜¾ç¤ºå®é™…å€¼) -->
                        <div v-if="!item.isGroup" class="absolute inset-0 bg-white opacity-40 transition-all duration-700 ease-out"
                             :style="{ transform: `translateY(${item.remaining}%)` }">
                        </div>

                        <!-- çº¹ç† -->
                        <div class="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMwMDAiLz4KPC9zdmc+')]"></div>

                        <!-- æ ‡ç­¾ -->
                        <div class="absolute top-3 left-3 bg-white/90 backdrop-blur-sm px-2 py-0.5 rounded text-[10px] font-bold tracking-wider uppercase shadow-sm text-slate-800">
                            {{ item.brand }}
                        </div>

                        <!-- è­¦å‘Šæ ‡è¯† (ä»…å•å·) -->
                        <div v-if="!item.isGroup && item.remaining <= 10 && item.remaining > 0" class="absolute top-3 right-3 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center shadow-md animate-pulse">
                            <i class="ph-bold ph-warning text-xs"></i>
                        </div>

                        <!-- ä¸­å¿ƒé¢œè‰²å -->
                        <div class="absolute inset-0 flex items-center justify-center p-4 text-center z-10">
                            <span class="font-bold text-lg leading-tight drop-shadow-md" :style="{ color: getContrastColor(item.colorHex) }">
                                {{ item.colorName }}
                            </span>
                        </div>
                    </div>

                    <!-- ä¿¡æ¯åŒº -->
                    <div class="bg-white p-3 border-t border-slate-100 flex flex-col justify-between h-[30%] rounded-b-2xl relative z-10">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide bg-slate-100 px-1.5 py-0.5 rounded">{{ item.type }}</span>
                            <span class="text-xs text-slate-400 font-mono">{{ item.colorHex.toUpperCase() }}</span>
                        </div>

                        <!-- åº•éƒ¨æ•°æ®å±•ç¤º -->
                        <div class="flex justify-between items-end mt-1">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-slate-400 uppercase">{{ item.isGroup ? 'æ€»åº“å­˜ä¼°ç®—' : 'å‰©ä½™' }}</span>
                                <span v-if="!item.isGroup" class="text-xl font-bold text-slate-800 leading-none">{{ item.remaining }}<small class="text-xs text-slate-400 font-normal">%</small></span>
                                <span v-else class="text-xl font-bold text-slate-800 leading-none">{{ (item.totalRemaining / 100).toFixed(1) }} <small class="text-xs text-slate-400 font-normal">å·</small></span>
                            </div>
                            <!-- è¿›åº¦æ¡ -->
                            <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full rounded-full"
                                     :class="item.isGroup ? 'bg-slate-800' : getProgressBarColor(item.remaining)"
                                     :style="{ width: item.isGroup ? '100%' : item.remaining + '%' }"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç©ºçŠ¶æ€ -->
            <div v-if="displayList.length === 0" class="text-center py-20 text-slate-400">
                <i class="ph-duotone ph-magnifying-glass text-4xl mb-2"></i>
                <p v-if="currentTab === 'stock'">åº“å­˜ä¸ºç©ºæˆ–æ— åŒ¹é…é¡¹</p>
                <p v-else>æ²¡æœ‰å·²è€—å°½çš„å†å²è®°å½•</p>
            </div>
        </div>
    </main>

    <!-- ä¸»ç¼–è¾‘ Modal (å•å·) -->
    <div v-if="showModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4" @click.self="closeModal">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden relative transform transition-all animate-fade-in-up flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="text-lg font-bold text-slate-800">{{ isEditing ? 'ç¼–è¾‘è€—æ' : 'å…¥åº“æ–°è€—æ' }}</h3>
                <button @click="closeModal" class="text-slate-400 hover:text-slate-600 p-1 rounded-full"><i class="ph-bold ph-x text-lg"></i></button>
            </div>

            <div class="p-6 space-y-5 overflow-y-auto">
                <!-- é¢„è®¾é€‰æ‹©å™¨ -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-slate-500 uppercase">âš¡ å¿«é€Ÿå¡«å……</label>
                        <select v-model="presetCategory" class="text-xs bg-slate-100 border-none rounded px-2 py-1 text-slate-600 focus:ring-0 cursor-pointer">
                            <option value="PLA Basic">PLA Basic</option>
                            <option value="PLA Matte">PLA Matte</option>
                            <option value="PETG Basic">PETG Basic</option>
                            <option value="ABS">ABS</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-8 gap-2 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div v-for="color in currentPresets" :key="color.hex" @click="applyPreset(color)"
                             class="group relative cursor-pointer flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full shadow-sm border border-slate-200 color-dot ring-2 ring-transparent group-hover:ring-slate-300"
                                 :style="{ backgroundColor: color.hex }" :title="color.name"></div>
                            <div v-if="form.colorHex.toLowerCase() === color.hex.toLowerCase()" class="absolute -top-1 -right-1 bg-green-500 text-white rounded-full w-3 h-3 border border-white"></div>
                        </div>
                    </div>
                </div>
                <hr class="border-slate-100 border-dashed">
                <!-- è¡¨å•å­—æ®µ -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase">å“ç‰Œ</label>
                        <div class="relative">
                            <select v-model="form.brand" class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 py-2.5 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option>Bambu Lab</option><option>eSun</option><option>PolyMaker</option><option>Sunlu</option><option>Kingroon</option><option>å…¶ä»–</option>
                            </select>
                            <i class="ph-bold ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-xs font-bold text-slate-500 uppercase">æè´¨</label>
                        <input v-model="form.type" list="materials" class="w-full bg-slate-50 border border-slate-200 text-slate-700 py-2.5 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="PLA Basic">
                        <datalist id="materials"><option value="PLA Basic"><option value="PLA Matte"><option value="PETG Basic"><option value="ABS"><option value="ASA"><option value="TPU 95A"></datalist>
                    </div>
                </div>
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 uppercase">é¢œè‰²å¾®è°ƒ</label>
                    <div class="flex gap-3">
                        <div class="relative w-12 h-12 flex-shrink-0 overflow-hidden rounded-lg shadow-sm border border-slate-200"><input type="color" v-model="form.colorHex" class="absolute -top-4 -left-4 w-20 h-20 cursor-pointer p-0 border-0"></div>
                        <input v-model="form.colorName" type="text" class="flex-grow bg-slate-50 border border-slate-200 text-slate-700 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="é¢œè‰²åç§°">
                    </div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="text-xs font-bold text-slate-500 uppercase flex items-center gap-1"><i class="ph-fill ph-drop"></i> å‰©ä½™é‡</label>
                        <span class="text-2xl font-black text-slate-800">{{ form.remaining }}%</span>
                    </div>
                    <input type="range" v-model.number="form.remaining" min="0" max="100" step="1" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-green-600 hover:accent-green-500">
                    <div class="flex justify-between gap-2">
                        <button v-for="p in [100, 75, 50, 25, 0]" :key="p" @click="form.remaining = p" class="flex-1 py-1.5 text-xs font-medium rounded border transition-colors" :class="form.remaining === p ? 'bg-green-600 text-white border-green-600' : 'bg-white text-slate-600 border-slate-200 hover:border-green-400'">{{ p == 0 ? 'ç©º' : p }}</button>
                    </div>
                    <p class="text-xs text-slate-400" v-if="form.remaining === 0">âš ï¸ ä¿å­˜åå°†ç§»å…¥â€œå·²è€—å°½â€åˆ—è¡¨</p>
                </div>
                <div class="space-y-1.5">
                    <label class="text-xs font-bold text-slate-500 uppercase">å¤‡æ³¨</label>
                    <input v-model="form.note" type="text" class="w-full bg-slate-50 border border-slate-200 text-slate-700 py-2.5 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="ä¾‹å¦‚ï¼šAMS æ’æ§½ 1">
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                <button v-if="isEditing" @click="deleteItem" class="text-red-500 hover:text-red-700 text-sm font-medium px-2 py-2 flex items-center gap-1"><i class="ph-bold ph-trash"></i> åˆ é™¤</button>
                <div v-else></div>
                <div class="flex gap-3">
                    <button @click="closeModal" class="px-5 py-2.5 rounded-lg text-slate-600 hover:bg-slate-200 font-medium transition-colors">å–æ¶ˆ</button>
                    <button @click="saveItem" :disabled="saving" class="px-6 py-2.5 rounded-lg bg-green-600 text-white font-medium hover:bg-green-700 shadow-lg shadow-green-600/20 transition-all flex items-center gap-2 disabled:opacity-50">
                        <span v-if="saving" class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                        {{ saving ? 'ä¿å­˜ä¸­' : 'ä¿å­˜' }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- èšåˆè¯¦æƒ… Modal (New!) -->
    <div v-if="showGroupModal && currentGroup" class="fixed inset-0 z-50 flex items-center justify-center p-4" @click.self="showGroupModal = false">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden relative animate-fade-in-up flex flex-col max-h-[80vh]">
            <!-- å¤´éƒ¨ï¼šå±•ç¤ºé¢œè‰²ä¿¡æ¯ -->
            <div class="px-6 py-6 text-white relative overflow-hidden" :style="{ backgroundColor: currentGroup.colorHex }">
                <div class="absolute inset-0 bg-black/10"></div>
                <div class="relative z-10 flex justify-between items-start">
                    <div>
                        <div class="text-xs font-medium opacity-80 uppercase tracking-wide">{{ currentGroup.brand }} Â· {{ currentGroup.type }}</div>
                        <h3 class="text-2xl font-bold mt-1" :style="{ color: getContrastColor(currentGroup.colorHex) }">{{ currentGroup.colorName }}</h3>
                        <div class="mt-2 inline-flex items-center gap-1 bg-black/20 backdrop-blur rounded-full px-3 py-1 text-sm">
                            <i class="ph-fill ph-stack"></i> å…± {{ currentGroup.items.length }} å·
                        </div>
                    </div>
                    <button @click="showGroupModal = false" class="text-white/80 hover:text-white bg-black/20 hover:bg-black/30 rounded-full p-1"><i class="ph-bold ph-x text-lg"></i></button>
                </div>
            </div>

            <!-- åˆ—è¡¨ -->
            <div class="p-4 space-y-3 overflow-y-auto bg-slate-50 flex-grow">
                <div v-for="item in currentGroup.items" :key="item.id"
                     @click="editItemFromGroup(item)"
                     class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center hover:border-green-300 hover:shadow-md transition cursor-pointer group">
                    <div>
                        <div class="text-sm font-bold text-slate-800">{{ item.remaining }}%</div>
                        <div class="text-xs text-slate-500 mt-0.5 truncate max-w-[150px]">{{ item.note || 'æ— å¤‡æ³¨' }}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="w-24 h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full rounded-full" :class="getProgressBarColor(item.remaining)" :style="{ width: item.remaining + '%' }"></div>
                        </div>
                        <i class="ph-bold ph-pencil-simple text-slate-300 group-hover:text-green-500"></i>
                    </div>
                </div>
            </div>

            <!-- åº•éƒ¨ï¼šå¿«é€Ÿæ·»åŠ åŒç±» -->
            <div class="p-4 border-t border-slate-200 bg-white">
                <button @click="duplicateItem(currentGroup.items[0])" class="w-full py-3 rounded-xl border-2 border-dashed border-slate-300 text-slate-500 font-medium hover:border-green-500 hover:text-green-600 hover:bg-green-50 transition flex items-center justify-center gap-2">
                    <i class="ph-bold ph-plus-circle"></i> æ·»åŠ ä¸€å·åŒç±»è€—æ
                </button>
            </div>
        </div>
    </div>

</div>

<!-- Vue 3 & Firebase Logic -->
<script type="module">
    import { createApp, ref, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot, serverTimestamp, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ğŸ”´ é…ç½®
    const firebaseConfig = {
        apiKey: "AIzaSyC_wj4kiFP2wkMdBtUhAS-w-9tiYQJrNAQ",
        authDomain: "filament-manager-841c4.firebaseapp.com",
        projectId: "filament-manager-841c4",
        storageBucket: "filament-manager-841c4.firebasestorage.app",
        messagingSenderId: "397724533964",
        appId: "1:397724533964:web:ee8fb919d57d8d17872e69",
        measurementId: "G-FKRW4KDPPR"
    };

    const PRESETS = {
        "PLA Basic": [
            { name: "Bambu Green", hex: "#00AE42" }, { name: "Black", hex: "#000000" }, { name: "White", hex: "#FFFFFF" },
            { name: "Gray", hex: "#8D9496" }, { name: "Red", hex: "#C8102E" }, { name: "Blue", hex: "#005EB8" },
            { name: "Orange", hex: "#FF6A13" }, { name: "Yellow", hex: "#FACC21" }
        ],
        "PLA Matte": [
            { name: "Matte Black", hex: "#292C2F" }, { name: "Matte White", hex: "#F2F2F2" }, { name: "Matte Dark Red", hex: "#7D252D" },
            { name: "Matte Marine Blue", hex: "#1D324F" }, { name: "Matte Ice Blue", hex: "#8AAAC3" }, { name: "Matte Grass Green", hex: "#638953" }
        ],
        "PETG Basic": [ { name: "Black", hex: "#121212" }, { name: "White", hex: "#F8F9FA" }, { name: "Gray", hex: "#7A7F85" } ],
        "ABS": [ { name: "Black", hex: "#1A1A1A" }, { name: "White", hex: "#FAFAFA" }, { name: "Red", hex: "#B71C1C" } ]
    };

    const app = createApp({
        setup() {
            const user = ref(null);
            const filaments = ref([]);
            const authLoading = ref(true);
            const configError = ref(false);
            const loadErrorMessage = ref('');
            const loadErrorTitle = ref('');
            const searchQuery = ref('');

            // ç•Œé¢çŠ¶æ€
            const currentTab = ref('stock'); // 'stock' | 'depleted'
            const isGrouped = ref(false);    // èšåˆå¼€å…³
            const showModal = ref(false);
            const showGroupModal = ref(false);
            const currentGroup = ref(null);  // å½“å‰å±•å¼€çš„èšåˆç»„

            const isEditing = ref(false);
            const saving = ref(false);
            const editingId = ref(null);
            const presetCategory = ref("PLA Basic");

            const form = ref({ brand: 'Bambu Lab', type: 'PLA Basic', colorName: 'Bambu Green', colorHex: '#00AE42', remaining: 100, note: '' });

            // Init Firebase
            let auth, db, googleProvider;
            try {
                if (!firebaseConfig.apiKey) {
                    configError.value = true;
                    authLoading.value = false;
                } else {
                    const firebaseApp = initializeApp(firebaseConfig);
                    auth = getAuth(firebaseApp);
                    db = getFirestore(firebaseApp);
                    googleProvider = new GoogleAuthProvider();
                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        authLoading.value = false;
                        if (u) loadFilaments(u.uid);
                        else filaments.value = [];
                    });
                }
            } catch (e) {
                console.error("Firebase Init Error", e);
                configError.value = true;
            }

            const loadFilaments = (uid) => {
                loadErrorMessage.value = '';
                const q = query(collection(db, 'filaments'), where("uid", "==", uid), orderBy("updatedAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    filaments.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }, (error) => {
                    if (error.code === 'permission-denied') {
                        loadErrorTitle.value = "æƒé™ä¸è¶³"; loadErrorMessage.value = "è¯·æ£€æŸ¥ Firebase æ§åˆ¶å°çš„ Firestore Rules æ˜¯å¦é…ç½®æ­£ç¡®ã€‚";
                    } else if (error.message.includes('index')) {
                        loadErrorTitle.value = "æ­£åœ¨æ„å»ºæ•°æ®åº“ç´¢å¼•"; loadErrorMessage.value = "Firestore æ­£åœ¨ä¸ºæ‚¨çš„æŸ¥è¯¢æ„å»ºç´¢å¼• (Index)ï¼Œè¯·ç¨å€™ 2-5 åˆ†é’Ÿ...";
                    } else {
                        loadErrorTitle.value = "åŠ è½½é”™è¯¯"; loadErrorMessage.value = error.message;
                    }
                });
            };

            // ğŸŸ¢ æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®è¿‡æ»¤ä¸èšåˆ
            const displayList = computed(() => {
                // 1. åŸºç¡€è¿‡æ»¤ (Tab & Search)
                let list = filaments.value.filter(item => {
                    // Tab è¿‡æ»¤
                    const isDepleted = item.remaining === 0;
                    if (currentTab.value === 'stock' && isDepleted) return false;
                    if (currentTab.value === 'depleted' && !isDepleted) return false;

                    // æœç´¢è¿‡æ»¤
                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        return item.colorName.toLowerCase().includes(q) ||
                                item.brand.toLowerCase().includes(q) ||
                                item.type.toLowerCase().includes(q) ||
                                (item.note && item.note.toLowerCase().includes(q));
                    }
                    return true;
                });

                // 2. èšåˆé€»è¾‘ (ä»…åœ¨ 'stock' tab ä¸” å¼€å¯èšåˆæ—¶)
                if (currentTab.value === 'stock' && isGrouped.value && !searchQuery.value) {
                    const groups = {};
                    const result = [];

                    list.forEach(item => {
                        // ç”Ÿæˆå”¯ä¸€Keyï¼šå“ç‰Œ+æè´¨+è‰²å€¼+è‰²å
                        const key = `${item.brand}|${item.type}|${item.colorHex}|${item.colorName}`;
                        if (!groups[key]) {
                            // åˆå§‹åŒ–ç»„
                            groups[key] = {
                                isGroup: true,
                                groupId: key,
                                brand: item.brand,
                                type: item.type,
                                colorName: item.colorName,
                                colorHex: item.colorHex,
                                items: [item],
                                count: 1,
                                totalRemaining: item.remaining
                            };
                            result.push(groups[key]);
                        } else {
                            // ç´¯åŠ 
                            groups[key].items.push(item);
                            groups[key].count++;
                            groups[key].totalRemaining += item.remaining;
                        }
                    });

                    // å¦‚æœæŸç»„åªæœ‰1ä¸ªï¼Œæ˜¯å¦æ‹†å¼€æ˜¾ç¤ºï¼Ÿä¸ºäº†ç»Ÿä¸€äº¤äº’ï¼Œè¿™é‡Œè®¾å®šï¼šå³ä¾¿æ˜¯1ä¸ªï¼Œå¦‚æœå¼€å¯èšåˆï¼Œä¹Ÿä¿æŒèšåˆæ ·å¼ï¼ˆæ–¹ä¾¿æ·»åŠ åŒç±»ï¼‰ï¼Œæˆ–è€…è¿˜åŸã€‚
                    // è¿™é‡Œä¸ºäº†UIä¸€è‡´æ€§ï¼Œæˆ‘ä»¬æŠŠ count=1 çš„è¿˜åŸæˆæ™®é€š item
                    return result.map(g => g.count === 1 ? g.items[0] : g);
                }

                return list;
            });

            const depletedCount = computed(() => filaments.value.filter(f => f.remaining === 0).length);
            const currentPresets = computed(() => PRESETS[presetCategory.value] || []);

            // äº¤äº’æ–¹æ³•
            const handleCardClick = (item) => {
                if (item.isGroup) {
                    currentGroup.value = item;
                    showGroupModal.value = true;
                } else {
                    editItem(item);
                }
            };

            const editItemFromGroup = (item) => {
                // å…³é—­ç»„ Modalï¼Œæ‰“å¼€ç¼–è¾‘ Modal
                // showGroupModal.value = false; // å¯é€‰ï¼šæ˜¯å¦ä¿ç•™ç»„Modalåœ¨èƒŒæ™¯ï¼Ÿé€šå¸¸å…³é—­ä½“éªŒæ›´å¥½
                editItem(item);
            };

            const duplicateItem = (templateItem) => {
                showGroupModal.value = false;
                openModal(); // æ‰“å¼€æ–°å¢
                // é¢„å¡«ä¿¡æ¯
                form.value = {
                    brand: templateItem.brand,
                    type: templateItem.type,
                    colorName: templateItem.colorName,
                    colorHex: templateItem.colorHex,
                    remaining: 100,
                    note: ''
                };
            };

            const applyPreset = (preset) => {
                form.value.brand = "Bambu Lab";
                form.value.type = presetCategory.value;
                form.value.colorName = preset.name;
                form.value.colorHex = preset.hex;
            };

            const login = async () => { try { await signInWithPopup(auth, googleProvider); } catch (e) { alert(e.message); } };
            const logout = () => signOut(auth);

            const openModal = () => {
                isEditing.value = false;
                form.value = { brand: 'Bambu Lab', type: 'PLA Basic', colorName: 'Bambu Green', colorHex: '#00AE42', remaining: 100, note: '' };
                presetCategory.value = "PLA Basic";
                showModal.value = true;
            };

            const editItem = (item) => {
                isEditing.value = true;
                editingId.value = item.id;
                form.value = { ...item };
                if (PRESETS[item.type]) presetCategory.value = item.type;
                showModal.value = true;
            };

            const closeModal = () => { showModal.value = false; editingId.value = null; };

            const saveItem = async () => {
                if (!user.value) return;
                saving.value = true;
                const data = { ...form.value, uid: user.value.uid, updatedAt: serverTimestamp() };
                try {
                    const timeout = new Promise((_, reject) => setTimeout(() => reject(new Error("ç½‘ç»œè¶…æ—¶")), 10000));
                    const req = isEditing.value && editingId.value
                            ? updateDoc(doc(db, 'filaments', editingId.value), data)
                            : addDoc(collection(db, 'filaments'), data);
                    await Promise.race([req, timeout]);
                    closeModal();
                    // å¦‚æœæ˜¯åœ¨ç»„é‡Œç¼–è¾‘çš„ï¼Œè¿™é‡Œå…¶å®ä¸ç”¨ç‰¹æ®Šå¤„ç†ï¼ŒSnapshotä¼šè‡ªåŠ¨æ›´æ–°ç»„æ•°æ®
                } catch (e) { alert("ä¿å­˜å¤±è´¥: " + e.message); }
                finally { saving.value = false; }
            };

            const deleteItem = async () => {
                if (!confirm("ç¡®å®šåˆ é™¤?")) return;
                try { await deleteDoc(doc(db, 'filaments', editingId.value)); closeModal(); }
                catch (e) { alert(e.message); }
            };

            const getContrastColor = (hex) => {
                if (!hex) return '#000';
                const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
                return (((r * 299) + (g * 587) + (b * 114)) / 1000) >= 128 ? '#1e293b' : '#ffffff';
            };

            const getProgressBarColor = (val) => val <= 10 ? 'bg-red-500' : (val <= 30 ? 'bg-amber-400' : 'bg-green-500');

            return {
                user, configError, authLoading, loadErrorMessage, loadErrorTitle, searchQuery,
                currentTab, isGrouped, displayList, depletedCount,
                showModal, isEditing, form, saving, currentPresets, presetCategory,
                showGroupModal, currentGroup, handleCardClick, editItemFromGroup, duplicateItem,
                login, logout, openModal, editItem, closeModal, saveItem, deleteItem,
                getContrastColor, getProgressBarColor, applyPreset
            };
        }
    });

    app.mount('#app');
</script>

<style>
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade-in { animation: fade-in 0.6s ease-out; }
    @keyframes fade-in-up { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .animate-fade-in-up { animation: fade-in-up 0.2s ease-out; }
</style>

</body>
</html>